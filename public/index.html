<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prodco-Verse ‚Äî Boutique AI Production Map</title>
    <meta name="description"
        content="An interactive constellation map of boutique AI production agencies, their founders, alumni pedigree, and notable projects.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0f;
            color: #e0e0e0;
            font-family: 'Inter', -apple-system, sans-serif;
            overflow: hidden;
        }

        /* ‚îÄ‚îÄ‚îÄ View Tabs ‚îÄ‚îÄ‚îÄ */
        .view-tabs {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .view-tab {
            padding: 4px 14px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: transparent;
            color: #888;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-tab.active {
            background: rgba(110, 231, 183, 0.15);
            color: #6ee7b7;
            border-color: rgba(110, 231, 183, 0.4);
        }

        .view-tab:hover:not(.active) {
            color: #ccc;
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* ‚îÄ‚îÄ‚îÄ List View ‚îÄ‚îÄ‚îÄ */
        #list-view {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 20px 30px;
            background: #0a0a0f;
            z-index: 50;
        }

        .list-section {
            margin-bottom: 32px;
        }

        .list-section h2 {
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .list-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .list-table th {
            text-align: left;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            padding: 6px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .list-table td {
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            vertical-align: top;
        }

        .list-table tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }

        .list-table .name-cell {
            font-weight: 600;
            color: #fff;
        }

        .list-table .bio-cell {
            color: #888;
            max-width: 500px;
            font-size: 12px;
            line-height: 1.4;
        }

        .list-table .link-cell a {
            color: #6ee7b7;
            text-decoration: none;
            font-size: 12px;
        }

        .list-table .link-cell a:hover {
            text-decoration: underline;
        }

        .type-pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .type-pill.agency {
            background: rgba(110, 231, 183, 0.15);
            color: #6ee7b7;
        }

        .type-pill.project {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .type-pill.traditional {
            background: rgba(167, 139, 250, 0.15);
            color: #a78bfa;
        }

        .type-pill.person {
            background: rgba(251, 113, 133, 0.15);
            color: #fb7185;
        }

        .type-pill.landmark {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: linear-gradient(180deg, rgba(10, 10, 15, 0.95) 0%, rgba(10, 10, 15, 0) 100%);
            padding: 20px 30px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        #header h1 {
            font-size: 22px;
            font-weight: 800;
            background: linear-gradient(135deg, #6ee7b7, #3b82f6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .mode-badge {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 3px 8px;
            border-radius: 4px;
            vertical-align: middle;
        }

        .mode-badge.agent {
            border: 1px solid #6ee7b7;
            color: #6ee7b7;
        }

        .mode-badge.readonly {
            border: 1px solid #fb7185;
            color: #fb7185;
        }

        .stats-row {
            display: flex;
            gap: 10px;
            font-size: 11px;
            color: #888;
        }

        .stats-row span {
            background: rgba(255, 255, 255, 0.06);
            padding: 3px 8px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .stats-row .num {
            color: #6ee7b7;
            font-weight: 700;
        }

        /* ‚îÄ‚îÄ‚îÄ Legend ‚îÄ‚îÄ‚îÄ */
        #legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(15, 15, 25, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px 20px;
            backdrop-filter: blur(12px);
        }

        #legend h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 10px;
        }

        .legend-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .legend-line {
            width: 20px;
            height: 2px;
            flex-shrink: 0;
            border-radius: 1px;
        }

        /* ‚îÄ‚îÄ‚îÄ Tooltip ‚îÄ‚îÄ‚îÄ */
        #tooltip {
            position: fixed;
            z-index: 200;
            pointer-events: none;
            background: rgba(15, 15, 25, 0.95);
            border: 1px solid rgba(110, 231, 183, 0.3);
            border-radius: 10px;
            padding: 12px 16px;
            backdrop-filter: blur(16px);
            display: none;
            max-width: 300px;
        }

        #tooltip .tt-name {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
        }

        #tooltip .tt-type {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #6ee7b7;
        }

        #tooltip .tt-meta {
            font-size: 11px;
            color: #888;
            margin-top: 6px;
        }

        /* ‚îÄ‚îÄ‚îÄ Filter Panel ‚îÄ‚îÄ‚îÄ */
        #filters {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 100;
            background: rgba(15, 15, 25, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px 20px;
            backdrop-filter: blur(12px);
        }

        #filters h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 10px;
        }

        #filters label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            margin-bottom: 6px;
            cursor: pointer;
        }

        #filters input[type="checkbox"] {
            accent-color: #6ee7b7;
        }

        #filters select {
            width: 100%;
            margin-top: 8px;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 12px;
        }

        svg {
            width: 100vw;
            height: 100vh;
        }

        /* ‚îÄ‚îÄ‚îÄ Research Panel (local only) ‚îÄ‚îÄ‚îÄ */
        #research-panel {
            position: fixed;
            top: 70px;
            left: 20px;
            z-index: 100;
            background: rgba(15, 15, 25, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px 20px;
            backdrop-filter: blur(12px);
            width: 260px;
            display: none;
        }

        #research-panel h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 10px;
        }

        #research-panel .selected-target {
            font-size: 13px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 10px;
            min-height: 20px;
        }

        #research-panel .selected-type {
            font-size: 10px;
            color: #6ee7b7;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        #research-panel textarea {
            width: 100%;
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
            min-height: 48px;
            outline: none;
            margin-bottom: 8px;
            transition: border-color 0.2s;
        }

        #research-panel textarea:focus {
            border-color: rgba(110, 231, 183, 0.5);
        }

        #research-panel textarea::placeholder {
            color: #555;
        }

        .btn-pin {
            width: 100%;
            padding: 8px;
            background: linear-gradient(135deg, #6ee7b7, #3b82f6);
            border: none;
            border-radius: 6px;
            color: #000;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-pin:hover {
            opacity: 0.9;
        }

        .btn-pin:disabled {
            opacity: 0.4;
            cursor: default;
        }

        #pin-status {
            font-size: 11px;
            color: #6ee7b7;
            margin-top: 8px;
            min-height: 16px;
        }

        .queue-badge {
            display: inline-block;
            background: rgba(251, 113, 133, 0.2);
            color: #fb7185;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 6px;
        }
    </style>
</head>

<body>
    <div id="header">
        <h1>üó∫Ô∏è Prodco-Verse</h1>
        <span id="mode-badge" class="mode-badge"></span>
        <div class="stats-row" id="stats-bar"></div>
        <div class="view-tabs">
            <button class="view-tab active" data-view="graph" onclick="switchView('graph')">üó∫Ô∏è Graph</button>
            <button class="view-tab" data-view="list" onclick="switchView('list')">üìã List</button>
        </div>
    </div>

    <!-- Research Panel (local agent mode only) -->
    <div id="research-panel">
        <h3>üìå Research Queue <span id="queue-badge" class="queue-badge" style="display:none"></span></h3>
        <div class="selected-target" id="selected-name">Click a node to select...</div>
        <div class="selected-type" id="selected-type"></div>
        <textarea id="pin-notes"
            placeholder="Notes for the agent (e.g. &quot;find their Vimeo&quot;, &quot;who founded this?&quot;)"></textarea>
        <button class="btn-pin" id="btn-pin" disabled onclick="pinTarget()">üìå Pin for Research</button>
        <div id="pin-status"></div>
    </div>

    <div id="legend">
        <h3>Nodes</h3>
        <div class="legend-row">
            <div class="legend-dot" style="background: #f59e0b; box-shadow: 0 0 8px #f59e0b;"></div> Landmark
        </div>
        <div class="legend-row">
            <div class="legend-dot" style="background: #6ee7b7;"></div> Agency
        </div>
        <div class="legend-row">
            <div class="legend-dot" style="background: #3b82f6;"></div> Project
        </div>
        <div class="legend-row">
            <div class="legend-dot" style="background: #a78bfa;"></div> Traditional
        </div>
        <div class="legend-row">
            <div class="legend-dot" style="background: #fb7185;"></div> Person
        </div>
        <h3 style="margin-top: 12px;">Edges</h3>
        <div class="legend-row">
            <div class="legend-line" style="background: #6ee7b7;"></div> Founder
        </div>
        <div class="legend-row">
            <div class="legend-line" style="background: #3b82f6;"></div> Alumni
        </div>
        <div class="legend-row">
            <div class="legend-line" style="background: #a78bfa;"></div> Partner
        </div>
        <div class="legend-row">
            <div class="legend-line" style="background: #f59e0b;"></div> Collaborator
        </div>
        <div class="legend-row">
            <div class="legend-line" style="background: #fb7185;"></div> Notable
        </div>
    </div>

    <div id="filters">
        <h3>Show Nodes</h3>
        <label><input type="checkbox" checked data-type="agency"> Agencies <span id="count-agency"
                style="color:#888; font-size:10px;">(0)</span></label>
        <label><input type="checkbox" checked data-type="project"> Projects <span id="count-project"
                style="color:#888; font-size:10px;">(0)</span></label>
        <label><input type="checkbox" checked data-type="traditional"> Traditionals <span id="count-traditional"
                style="color:#888; font-size:10px;">(0)</span></label>
        <label><input type="checkbox" checked data-type="person"> People <span id="count-person"
                style="color:#888; font-size:10px;">(0)</span></label>
        <h3 style="margin-top: 12px;">Focus Landmark</h3>
        <select id="landmark-select">
            <option value="">All Landmarks</option>
        </select>
    </div>

    <div id="tooltip">
        <div class="tt-name"></div>
        <div class="tt-type"></div>
        <div class="tt-meta"></div>
    </div>

    <div id="graph-view">
        <svg></svg>
    </div>

    <div id="list-view"></div>

    <script>
        let currentTargetNode = null;
        let graphData = null;
        const isViewOnly = window.location.hostname.includes('vercel.app');

        const NODE_COLORS = {
            agency: '#6ee7b7',
            project: '#3b82f6',
            traditional: '#a78bfa',
            person: '#fb7185'
        };

        const EDGE_COLORS = {
            founder: '#6ee7b7',
            alumni: '#3b82f6',
            partner: '#a78bfa',
            collaborator: '#f59e0b',
            notable: '#fb7185',
            competitor: '#f97316'
        };

        const NODE_RADIUS = {
            agency: 8,
            project: 3,
            traditional: 5,
            person: 7
        };

        // ‚îÄ‚îÄ‚îÄ View Switching ‚îÄ‚îÄ‚îÄ
        function switchView(view) {
            document.querySelectorAll('.view-tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
            document.getElementById('graph-view').style.display = view === 'graph' ? 'block' : 'none';
            document.getElementById('list-view').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('legend').style.display = view === 'graph' ? 'block' : 'none';
            document.getElementById('filters').style.display = view === 'graph' ? 'block' : 'none';
            document.getElementById('research-panel').style.display = (view === 'graph' && !isViewOnly) ? 'block' : 'none';
            if (view === 'list') buildListView();
        }

        function buildListView() {
            if (!graphData) return;
            const container = document.getElementById('list-view');
            const nodeEntries = Object.entries(graphData.nodes);

            const sections = [
                { title: 'üè¢ Agencies', type: 'agency', color: '#6ee7b7' },
                { title: 'üé¨ Projects', type: 'project', color: '#3b82f6' },
                { title: 'üë§ People', type: 'person', color: '#fb7185' },
                { title: 'üèõÔ∏è Traditional Companies', type: 'traditional', color: '#a78bfa' },
            ];

            let html = '';
            for (const sec of sections) {
                const items = nodeEntries
                    .filter(([k, n]) => n.type === sec.type)
                    .sort((a, b) => (b[1].connections || 0) - (a[1].connections || 0));

                html += `<div class="list-section">`;
                html += `<h2 style="color:${sec.color}">${sec.title} (${items.length})</h2>`;
                html += `<table class="list-table"><thead><tr>`;
                html += `<th>Name</th><th>Links</th><th>Details</th><th>URL</th>`;
                html += `</tr></thead><tbody>`;

                for (const [key, node] of items) {
                    const pills = [];
                    if (node.isLandmark) pills.push('<span class="type-pill landmark">‚òÖ Landmark</span>');
                    if (node.isNotable) pills.push('<span class="type-pill project">Notable</span>');
                    if (node.isViral) pills.push('<span class="type-pill agency">Viral</span>');

                    const bio = node.bio || '';
                    const url = node.url ? `<a href="${node.url}" target="_blank">View ‚Üó</a>` : '';
                    const social = [];
                    if (node.linkedIn) social.push(`<a href="${node.linkedIn}" target="_blank">LinkedIn</a>`);
                    if (node.twitter) social.push(`<a href="${node.twitter}" target="_blank">ùïè</a>`);

                    html += `<tr>`;
                    html += `<td class="name-cell">${node.name || key} ${pills.join(' ')}</td>`;
                    html += `<td style="color:#6ee7b7;text-align:center;">${node.connections || 0}</td>`;
                    html += `<td class="bio-cell">${bio}</td>`;
                    html += `<td class="link-cell">${url} ${social.join(' ')}</td>`;
                    html += `</tr>`;
                }

                html += `</tbody></table></div>`;
            }

            container.innerHTML = html;
        }

        async function init() {
            // ‚îÄ‚îÄ‚îÄ Mode Badge ‚îÄ‚îÄ‚îÄ
            const badge = document.getElementById('mode-badge');
            if (isViewOnly) {
                badge.textContent = 'VIEW ONLY';
                badge.className = 'mode-badge readonly';
            } else {
                badge.textContent = 'AGENT MODE';
                badge.className = 'mode-badge agent';
                document.getElementById('research-panel').style.display = 'block';
                loadQueueCount();
            }

            const res = await fetch('/api/mapper/graph');
            const graph = await res.json();
            graphData = graph;

            // ‚îÄ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ
            const statsBar = document.getElementById('stats-bar');
            statsBar.innerHTML = `
                <span><span class="num">${graph.landmarks.length}</span> landmarks</span>
                <span><span class="num">${Object.keys(graph.nodes).length}</span> nodes</span>
                <span><span class="num">${graph.edges.length}</span> edges</span>
            `;

            // ‚îÄ‚îÄ‚îÄ Landmark Dropdown ‚îÄ‚îÄ‚îÄ
            const landmarkSelect = document.getElementById('landmark-select');
            graph.landmarks.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l.name;
                opt.textContent = l.name;
                landmarkSelect.appendChild(opt);
            });

            // ‚îÄ‚îÄ‚îÄ Dynamic Counts ‚îÄ‚îÄ‚îÄ
            const counts = { agency: 0, project: 0, traditional: 0, person: 0 };
            Object.values(graph.nodes).forEach(n => {
                if (counts[n.type] !== undefined) counts[n.type]++;
            });
            for (const [type, count] of Object.entries(counts)) {
                const el = document.getElementById(`count-${type}`);
                if (el) el.textContent = `(${count})`;
            }

            // ‚îÄ‚îÄ‚îÄ Convert to D3 Format ‚îÄ‚îÄ‚îÄ
            const nodeMap = {};
            const nodes = [];
            const visibleTypes = new Set(['agency', 'traditional', 'person']);

            for (const [key, data] of Object.entries(graph.nodes)) {
                const node = { id: key, ...data };
                node.radius = data.isLandmark ? 16 : (NODE_RADIUS[data.type] || 4);

                if (data.type === 'project' && (data.isViral || data.isNotable)) {
                    node.radius += 3;
                    node.color = '#f59e0b';
                } else {
                    node.color = data.isLandmark ? '#f59e0b' : (NODE_COLORS[data.type] || '#555');
                }

                node.isUnmapped = (data.type === 'agency' && data.mapStatus === 'unmapped');
                nodeMap[key] = node;
                nodes.push(node);
            }

            const links = graph.edges
                .filter(e => nodeMap[e.from] && nodeMap[e.to])
                .map(e => ({
                    source: e.from,
                    target: e.to,
                    axis: e.axis,
                    weight: e.weight,
                    color: EDGE_COLORS[e.axis] || '#333'
                }));

            // ‚îÄ‚îÄ‚îÄ SVG ‚îÄ‚îÄ‚îÄ
            const width = window.innerWidth;
            const height = window.innerHeight;
            const svg = d3.select('svg').attr('width', width).attr('height', height);
            const g = svg.append('g');

            const zoom = d3.zoom()
                .scaleExtent([0.1, 8])
                .on('zoom', (event) => g.attr('transform', event.transform));
            svg.call(zoom);
            svg.call(zoom.transform, d3.zoomIdentity.translate(width / 2, height / 2).scale(0.4));

            // ‚îÄ‚îÄ‚îÄ Forces ‚îÄ‚îÄ‚îÄ
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(d => {
                    if (d.axis === 'partner') return 30;
                    if (d.axis === 'founder') return 80;
                    return 60;
                }).strength(d => d.weight * 0.3))
                .force('charge', d3.forceManyBody().strength(d => d.isLandmark ? -400 : -20))
                .force('center', d3.forceCenter(0, 0))
                .force('collision', d3.forceCollide().radius(d => d.radius + 2))
                .alphaDecay(0.02);

            // ‚îÄ‚îÄ‚îÄ Draw ‚îÄ‚îÄ‚îÄ
            let link = g.append('g').selectAll('line').data(links).join('line')
                .attr('stroke', d => d.color)
                .attr('stroke-opacity', 0.15)
                .attr('stroke-width', d => Math.max(0.3, d.weight));

            let node = g.append('g').selectAll('circle').data(nodes).join('circle')
                .attr('r', d => d.radius)
                .attr('fill', d => d.isUnmapped ? 'transparent' : d.color)
                .attr('stroke', d => d.isLandmark ? '#f59e0b' : d.isUnmapped ? '#fb7185' : 'none')
                .attr('stroke-width', d => d.isLandmark ? 3 : d.isUnmapped ? 2 : 0)
                .attr('stroke-dasharray', d => d.isUnmapped ? '3,2' : 'none')
                .attr('opacity', d => visibleTypes.has(d.type) || d.isLandmark ? 1 : 0.05)
                .style('cursor', 'pointer')
                .call(d3.drag()
                    .on('start', (e, d) => { if (!e.active) simulation.alphaTarget(0.1).restart(); d.fx = d.x; d.fy = d.y; })
                    .on('drag', (e, d) => { d.fx = e.x; d.fy = e.y; })
                    .on('end', (e, d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; })
                );

            // Glow
            node.filter(d => d.isLandmark).attr('filter', 'url(#glow)');
            const defs = svg.append('defs');
            const filter = defs.append('filter').attr('id', 'glow');
            filter.append('feGaussianBlur').attr('stdDeviation', '4').attr('result', 'coloredBlur');
            const feMerge = filter.append('feMerge');
            feMerge.append('feMergeNode').attr('in', 'coloredBlur');
            feMerge.append('feMergeNode').attr('in', 'SourceGraphic');

            // Stars for notable/viral
            const viralNodes = nodes.filter(d => d.isViral || d.isNotable);
            let stars = g.append('g').selectAll('text').data(viralNodes).join('text')
                .text('‚≠ê')
                .attr('font-size', '16px')
                .attr('text-anchor', 'middle')
                .attr('dy', '5px')
                .style('pointer-events', 'none')
                .style('text-shadow', '0 0 6px rgba(0,0,0,0.9)');

            // Labels
            const labelNodes = nodes.filter(d => d.isLandmark || (d.type === 'agency' && d.connections > 3));
            let labels = g.append('g').selectAll('text').data(labelNodes).join('text')
                .text(d => d.name)
                .attr('font-size', d => d.isLandmark ? '13px' : '9px')
                .attr('font-weight', d => d.isLandmark ? '800' : '500')
                .attr('fill', d => d.isLandmark ? '#f59e0b' : '#ccc')
                .attr('text-anchor', 'middle')
                .attr('dy', d => -(d.radius + 6))
                .style('pointer-events', 'none')
                .style('text-shadow', '0 0 6px rgba(0,0,0,0.9)');

            // ‚îÄ‚îÄ‚îÄ Tooltip ‚îÄ‚îÄ‚îÄ
            const tooltip = document.getElementById('tooltip');
            let hideTimeout;

            node.on('mouseover', (event, d) => {
                clearTimeout(hideTimeout);
                tooltip.style.display = 'block';
                tooltip.style.pointerEvents = 'auto';

                tooltip.querySelector('.tt-name').textContent = d.name || d.id;

                let typeHtml = d.type + (d.isLandmark ? ' ¬∑ LANDMARK' : '');
                if (d.source === 'agent') typeHtml += ' ü§ñ';
                tooltip.querySelector('.tt-type').textContent = typeHtml;

                let metaHtml = '';
                if (d.bio) metaHtml += `<div style="color: #e2e8f0; margin-bottom: 6px; line-height: 1.3;">${d.bio}</div>`;
                if (d.url) metaHtml += `<div style="margin-bottom: 6px;"><a href="${d.url}" target="_blank" style="color: #6ee7b7; text-decoration: underline;">View Project ‚Üó</a></div>`;

                let linksHtml = '';
                if (d.linkedIn) linksHtml += `<a href="${d.linkedIn}" target="_blank" style="color: #3b82f6; text-decoration: none; margin-right: 8px;">in</a>`;
                if (d.twitter) linksHtml += `<a href="${d.twitter}" target="_blank" style="color: #1da1f2; text-decoration: none;">ùïè</a>`;
                if (linksHtml) metaHtml += `<div style="margin-top: 6px; font-weight: bold;">${linksHtml}</div>`;

                if (d.connections) metaHtml += `<div style="margin-top: 4px; color: #888;">Links: ${d.connections}</div>`;
                tooltip.querySelector('.tt-meta').innerHTML = metaHtml;

                // Highlight connections
                const connectedIds = new Set();
                links.forEach(l => {
                    const src = typeof l.source === 'object' ? l.source.id : l.source;
                    const tgt = typeof l.target === 'object' ? l.target.id : l.target;
                    if (src === d.id) connectedIds.add(tgt);
                    if (tgt === d.id) connectedIds.add(src);
                });
                node.attr('opacity', n => n.id === d.id || connectedIds.has(n.id) ? 1 : 0.08);
                link.attr('stroke-opacity', l => {
                    const src = typeof l.source === 'object' ? l.source.id : l.source;
                    const tgt = typeof l.target === 'object' ? l.target.id : l.target;
                    return src === d.id || tgt === d.id ? 0.6 : 0.03;
                });
            })
                .on('mousemove', (event) => {
                    tooltip.style.left = (event.clientX + 16) + 'px';
                    tooltip.style.top = (event.clientY - 10) + 'px';
                })
                .on('mouseout', () => {
                    hideTimeout = setTimeout(() => { tooltip.style.display = 'none'; }, 500);
                    node.attr('opacity', d => visibleTypes.has(d.type) || d.isLandmark ? 1 : 0.05);
                    link.attr('stroke-opacity', 0.15);
                });

            tooltip.addEventListener('mouseenter', () => clearTimeout(hideTimeout));
            tooltip.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; });

            // ‚îÄ‚îÄ‚îÄ Node Selection (for pinning) ‚îÄ‚îÄ‚îÄ
            node.on('click', (event, d) => {
                if (event.defaultPrevented) return;
                currentTargetNode = d;

                // Highlight selected
                node.attr('stroke', n => n.id === d.id ? '#fff' : (n.isLandmark ? '#f59e0b' : (n.isUnmapped ? '#fb7185' : 'none')))
                    .attr('stroke-width', n => n.id === d.id ? 4 : (n.isLandmark ? 3 : (n.isUnmapped ? 2 : 0)))
                    .attr('stroke-dasharray', n => n.id === d.id ? '4,4' : (n.isUnmapped ? '3,2' : 'none'));

                // Update research panel
                if (!isViewOnly) {
                    document.getElementById('selected-name').textContent = d.name;
                    document.getElementById('selected-type').textContent = d.type + (d.isLandmark ? ' ¬∑ LANDMARK' : '');
                    document.getElementById('btn-pin').disabled = false;
                }
            });

            // ‚îÄ‚îÄ‚îÄ Tick ‚îÄ‚îÄ‚îÄ
            simulation.on('tick', () => {
                link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                node.attr('cx', d => d.x).attr('cy', d => d.y);
                labels.attr('x', d => d.x).attr('y', d => d.y);
                stars.attr('x', d => d.x).attr('y', d => d.y);
            });

            // ‚îÄ‚îÄ‚îÄ Filter Handlers ‚îÄ‚îÄ‚îÄ
            document.querySelectorAll('#filters input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    const type = cb.dataset.type;
                    if (cb.checked) visibleTypes.add(type);
                    else visibleTypes.delete(type);
                    node.attr('opacity', d => visibleTypes.has(d.type) || d.isLandmark ? 1 : 0.05);
                    node.attr('r', d => visibleTypes.has(d.type) || d.isLandmark ? d.radius : 1);
                });
            });

            landmarkSelect.addEventListener('change', () => {
                const selected = landmarkSelect.value;
                if (!selected) {
                    node.attr('opacity', d => visibleTypes.has(d.type) || d.isLandmark ? 1 : 0.05);
                    link.attr('stroke-opacity', 0.15);
                    return;
                }

                const lmKey = Object.keys(graph.nodes).find(k =>
                    graph.nodes[k].name?.toLowerCase() === selected.toLowerCase() && graph.nodes[k].isLandmark
                );
                if (!lmKey) return;

                const connected = new Set([lmKey]);
                graph.edges.forEach(e => {
                    if (e.from === lmKey) connected.add(e.to);
                    if (e.to === lmKey) connected.add(e.from);
                });

                node.attr('opacity', d => connected.has(d.id) ? 1 : 0.04);
                link.attr('stroke-opacity', l => {
                    const src = typeof l.source === 'object' ? l.source.id : l.source;
                    const tgt = typeof l.target === 'object' ? l.target.id : l.target;
                    return connected.has(src) && connected.has(tgt) ? 0.5 : 0.02;
                });
            });
        }

        // ‚îÄ‚îÄ‚îÄ Pin for Research ‚îÄ‚îÄ‚îÄ
        async function pinTarget() {
            if (isViewOnly || !currentTargetNode) return;
            const btn = document.getElementById('btn-pin');
            const status = document.getElementById('pin-status');
            const notes = document.getElementById('pin-notes').value.trim();

            btn.disabled = true;
            btn.textContent = '‚è≥ Pinning...';

            try {
                const res = await fetch('/api/mapper/pin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        targetNode: currentTargetNode.id,
                        targetName: currentTargetNode.name,
                        action: 'research',
                        notes
                    })
                });
                const data = await res.json();
                status.innerHTML = `<span style="color:#6ee7b7">‚úÖ Pinned "${currentTargetNode.name}" ‚Äî ${data.queued} in queue</span>`;
                document.getElementById('pin-notes').value = '';
                loadQueueCount();
            } catch (err) {
                status.innerHTML = `<span style="color:#fb7185">‚ùå ${err.message}</span>`;
            }

            btn.disabled = false;
            btn.textContent = 'üìå Pin for Research';
        }

        // ‚îÄ‚îÄ‚îÄ Queue Counter ‚îÄ‚îÄ‚îÄ
        async function loadQueueCount() {
            try {
                const res = await fetch('/api/mapper/queue');
                const queue = await res.json();
                const badge = document.getElementById('queue-badge');
                if (queue.length > 0) {
                    badge.textContent = queue.length;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            } catch (e) { /* ignore */ }
        }

        init();
    </script>
</body>

</html>