<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prodco-Verse ‚Äî Boutique AI Production Map</title>
    <meta name="description"
        content="An interactive constellation map of boutique AI production agencies, their founders, alumni pedigree, and notable projects.">

    <!-- Open Graph / Link Preview -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Prodco-Verse ‚Äî Boutique AI Production Map">
    <meta property="og:description"
        content="üÜï New discoveries this session ‚Äî an interactive map of boutique AI production agencies, founders, pedigree, and notable projects.">
    <meta property="og:image" content="/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Prodco-Verse ‚Äî Boutique AI Production Map">
    <meta name="twitter:description"
        content="üÜï New discoveries this session ‚Äî mapping the AI creative production landscape.">
    <meta name="twitter:image" content="/og-image.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0f;
            color: #e0e0e0;
            font-family: 'Inter', -apple-system, sans-serif;
            overflow: hidden;
        }

        /* ‚îÄ‚îÄ‚îÄ View Tabs ‚îÄ‚îÄ‚îÄ */
        .view-tabs {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .view-tab {
            padding: 4px 14px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: transparent;
            color: #888;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-tab.active {
            background: rgba(110, 231, 183, 0.15);
            color: #6ee7b7;
            border-color: rgba(110, 231, 183, 0.4);
        }

        .view-tab:hover:not(.active) {
            color: #ccc;
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* ‚îÄ‚îÄ‚îÄ List View ‚îÄ‚îÄ‚îÄ */
        #list-view {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 40px 48px 80px;
            background: #0a0a0f;
            z-index: 50;
            scrollbar-width: thin;
            scrollbar-color: rgba(110, 231, 183, 0.2) transparent;
        }

        #list-view::-webkit-scrollbar {
            width: 5px;
        }

        #list-view::-webkit-scrollbar-thumb {
            background: rgba(110, 231, 183, 0.15);
            border-radius: 3px;
        }

        /* ‚îÄ Agency Block ‚îÄ */
        /* ‚îÄ Changelog Banner ‚îÄ */
        .changelog-banner {
            background: rgba(110, 231, 183, 0.04);
            border: 1px solid rgba(110, 231, 183, 0.12);
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 32px;
        }

        .changelog-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #6ee7b7;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .changelog-entry {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .changelog-entry:last-child {
            border-bottom: none;
        }

        .changelog-entry-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 4px;
        }

        .changelog-entry-title {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
        }

        .changelog-date {
            font-size: 10px;
            color: #555;
            margin-left: auto;
        }

        .changelog-type {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1px 6px;
            border-radius: 3px;
        }

        .changelog-type.addition {
            color: #6ee7b7;
            background: rgba(110, 231, 183, 0.12);
        }

        .changelog-type.update {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.12);
        }

        .changelog-desc {
            font-size: 12px;
            color: #888;
            line-height: 1.5;
            margin-bottom: 6px;
        }

        .changelog-items {
            display: flex;
            flex-wrap: wrap;
            gap: 4px 10px;
        }

        .changelog-item {
            font-size: 12px;
            font-weight: 600;
            color: #d1d5db;
        }

        .changelog-item::before {
            content: '+ ';
            color: #6ee7b7;
        }

        .changelog-toggle {
            font-size: 11px;
            font-weight: 600;
            color: #6ee7b7;
            cursor: pointer;
            border: none;
            background: none;
            padding: 8px 0 0;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .changelog-toggle:hover {
            opacity: 1;
        }

        .changelog-history {
            display: none;
        }

        .changelog-history.open {
            display: block;
        }

        .agency-block {
            margin-bottom: 48px;
        }

        .agency-header {
            display: flex;
            align-items: baseline;
            gap: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            margin-bottom: 16px;
        }

        .agency-name {
            font-size: 20px;
            font-weight: 800;
            color: #fff;
        }

        .agency-name.landmark {
            color: #f59e0b;
        }

        .agency-tag {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.12);
            padding: 2px 7px;
            border-radius: 3px;
        }

        .agency-date {
            font-size: 10px;
            font-weight: 500;
            color: #444;
            margin-left: auto;
        }

        .agency-bio {
            font-size: 13px;
            line-height: 1.6;
            color: #888;
            margin-bottom: 16px;
            max-width: 700px;
        }

        /* ‚îÄ Sub-sections ‚îÄ */
        .sub-section {
            margin-bottom: 14px;
            margin-left: 2px;
        }

        .sub-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 8px;
        }

        .sub-label.people {
            color: #fb7185;
        }

        .sub-label.projects {
            color: #3b82f6;
        }

        .sub-label.pedigree {
            color: #a78bfa;
        }

        /* ‚îÄ Person Row ‚îÄ */
        .person-row {
            display: flex;
            align-items: baseline;
            gap: 10px;
            padding: 5px 0;
            flex-wrap: wrap;
        }

        .person-name {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
        }

        .person-role {
            font-size: 11px;
            color: #6ee7b7;
            font-weight: 600;
        }

        .person-bio {
            font-size: 12px;
            color: #666;
            flex-basis: 100%;
            margin-top: 2px;
            line-height: 1.5;
        }

        .person-links {
            display: inline-flex;
            gap: 6px;
        }

        .person-links a {
            font-size: 11px;
            color: #555;
            text-decoration: none;
            transition: color 0.15s;
        }

        .person-links a:hover {
            color: #fff;
        }

        /* ‚îÄ Project Row ‚îÄ */
        .project-row {
            display: flex;
            align-items: baseline;
            gap: 8px;
            padding: 3px 0;
        }

        .project-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: #3b82f6;
            flex-shrink: 0;
            margin-top: 6px;
        }

        .project-dot.notable {
            background: #f59e0b;
        }

        .project-name {
            font-size: 13px;
            font-weight: 600;
            color: #ccc;
        }

        .project-name a {
            color: inherit;
            text-decoration: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: border-color 0.15s;
        }

        .project-name a:hover {
            border-color: rgba(255, 255, 255, 0.4);
        }

        .project-flag {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1px 5px;
            border-radius: 3px;
        }

        .project-flag.notable {
            background: rgba(245, 158, 11, 0.12);
            color: #f59e0b;
        }

        .project-flag.viral {
            background: rgba(236, 72, 153, 0.10);
            color: #f472b6;
        }

        /* ‚îÄ Pedigree Row ‚îÄ */
        .pedigree-row {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 0;
            margin-right: 16px;
        }

        .pedigree-name {
            font-size: 12px;
            color: #a78bfa;
            font-weight: 600;
        }

        .pedigree-via {
            font-size: 10px;
            color: #555;
        }

        /* ‚îÄ Related Agencies ‚îÄ */
        .related-row {
            display: flex;
            align-items: baseline;
            gap: 6px;
            padding: 3px 0;
        }

        .related-arrow {
            color: #f59e0b;
            font-size: 11px;
        }

        .related-name {
            font-size: 13px;
            font-weight: 600;
            color: #f59e0b;
        }

        .related-reason {
            font-size: 11px;
            color: #555;
        }

        /* ‚îÄ Others footer ‚îÄ */
        .others-section {
            margin-top: 48px;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .others-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #555;
            margin-bottom: 12px;
        }

        .others-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px 16px;
        }

        .others-item {
            font-size: 12px;
            color: #666;
        }

        /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: linear-gradient(180deg, rgba(10, 10, 15, 0.95) 0%, rgba(10, 10, 15, 0) 100%);
            padding: 20px 30px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        #header h1 {
            font-size: 22px;
            font-weight: 800;
            background: linear-gradient(135deg, #6ee7b7, #3b82f6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .mode-badge {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 3px 8px;
            border-radius: 4px;
            vertical-align: middle;
        }

        .mode-badge.agent {
            border: 1px solid #6ee7b7;
            color: #6ee7b7;
        }

        .mode-badge.readonly {
            border: 1px solid #fb7185;
            color: #fb7185;
        }

        .stats-row {
            display: flex;
            gap: 10px;
            font-size: 11px;
            color: #888;
        }

        .stats-row span {
            background: rgba(255, 255, 255, 0.06);
            padding: 3px 8px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .stats-row .num {
            color: #6ee7b7;
            font-weight: 700;
        }

        /* ‚îÄ‚îÄ‚îÄ Legend ‚îÄ‚îÄ‚îÄ */
        #legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(15, 15, 25, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px 20px;
            backdrop-filter: blur(12px);
        }

        #legend h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 10px;
        }

        .legend-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .legend-line {
            width: 20px;
            height: 2px;
            flex-shrink: 0;
            border-radius: 1px;
        }

        /* ‚îÄ‚îÄ‚îÄ Tooltip ‚îÄ‚îÄ‚îÄ */
        #tooltip {
            position: fixed;
            z-index: 200;
            pointer-events: none;
            background: rgba(15, 15, 25, 0.95);
            border: 1px solid rgba(110, 231, 183, 0.3);
            border-radius: 10px;
            padding: 12px 16px;
            backdrop-filter: blur(16px);
            display: none;
            max-width: 300px;
        }

        #tooltip .tt-name {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
        }

        #tooltip .tt-type {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #6ee7b7;
        }

        #tooltip .tt-meta {
            font-size: 11px;
            color: #888;
            margin-top: 6px;
        }

        /* ‚îÄ‚îÄ‚îÄ Filter Panel ‚îÄ‚îÄ‚îÄ */
        #filters {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 100;
            background: rgba(15, 15, 25, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px 20px;
            backdrop-filter: blur(12px);
        }

        #filters h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 10px;
        }

        #filters label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            margin-bottom: 6px;
            cursor: pointer;
        }

        #filters input[type="checkbox"] {
            accent-color: #6ee7b7;
        }

        #filters select {
            width: 100%;
            margin-top: 8px;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 12px;
        }

        svg {
            width: 100vw;
            height: 100vh;
        }

        /* ‚îÄ‚îÄ‚îÄ Research Panel (local only) ‚îÄ‚îÄ‚îÄ */
        #research-panel {
            position: fixed;
            top: 70px;
            left: 20px;
            z-index: 100;
            background: rgba(15, 15, 25, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px 20px;
            backdrop-filter: blur(12px);
            width: 260px;
            display: none;
        }

        #research-panel h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 10px;
        }

        #research-panel .selected-target {
            font-size: 13px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 10px;
            min-height: 20px;
        }

        #research-panel .selected-type {
            font-size: 10px;
            color: #6ee7b7;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        #research-panel textarea {
            width: 100%;
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
            min-height: 48px;
            outline: none;
            margin-bottom: 8px;
            transition: border-color 0.2s;
        }

        #research-panel textarea:focus {
            border-color: rgba(110, 231, 183, 0.5);
        }

        #research-panel textarea::placeholder {
            color: #555;
        }

        .btn-pin {
            width: 100%;
            padding: 8px;
            background: linear-gradient(135deg, #6ee7b7, #3b82f6);
            border: none;
            border-radius: 6px;
            color: #000;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-pin:hover {
            opacity: 0.9;
        }

        .btn-pin:disabled {
            opacity: 0.4;
            cursor: default;
        }

        #pin-status {
            font-size: 11px;
            color: #6ee7b7;
            margin-top: 8px;
            min-height: 16px;
        }

        .queue-badge {
            display: inline-block;
            background: rgba(251, 113, 133, 0.2);
            color: #fb7185;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 6px;
        }
    </style>
</head>

<body>
    <div id="header">
        <h1>üó∫Ô∏è Prodco-Verse</h1>
        <span id="mode-badge" class="mode-badge"></span>
        <div class="stats-row" id="stats-bar"></div>
        <div class="view-tabs">
            <button class="view-tab active" data-view="graph" onclick="switchView('graph')">üó∫Ô∏è Graph</button>
            <button class="view-tab" data-view="list" onclick="switchView('list')">üìã List</button>
        </div>
    </div>

    <!-- Research Panel (local agent mode only) -->
    <div id="research-panel">
        <h3>üìå Research Queue <span id="queue-badge" class="queue-badge" style="display:none"></span></h3>
        <div class="selected-target" id="selected-name">Click a node to select...</div>
        <div class="selected-type" id="selected-type"></div>
        <textarea id="pin-notes"
            placeholder="Notes for the agent (e.g. &quot;find their Vimeo&quot;, &quot;who founded this?&quot;)"></textarea>
        <button class="btn-pin" id="btn-pin" disabled onclick="pinTarget()">üìå Pin for Research</button>
        <div id="pin-status"></div>
    </div>

    <div id="legend">
        <h3>Nodes</h3>
        <div class="legend-row">
            <div class="legend-dot" style="background: #f59e0b; box-shadow: 0 0 8px #f59e0b;"></div> Landmark
        </div>
        <div class="legend-row">
            <div class="legend-dot" style="background: #6ee7b7;"></div> Agency
        </div>
        <div class="legend-row">
            <div class="legend-dot" style="background: #3b82f6;"></div> Project
        </div>
        <div class="legend-row">
            <div class="legend-dot" style="background: #a78bfa;"></div> Traditional
        </div>
        <div class="legend-row">
            <div class="legend-dot" style="background: #fb7185;"></div> Person
        </div>
        <h3 style="margin-top: 12px;">Edges</h3>
        <div class="legend-row">
            <div class="legend-line" style="background: #6ee7b7;"></div> Founder
        </div>
        <div class="legend-row">
            <div class="legend-line" style="background: #3b82f6;"></div> Alumni
        </div>
        <div class="legend-row">
            <div class="legend-line" style="background: #a78bfa;"></div> Partner
        </div>
        <div class="legend-row">
            <div class="legend-line" style="background: #f59e0b;"></div> Collaborator
        </div>
        <div class="legend-row">
            <div class="legend-line" style="background: #fb7185;"></div> Notable
        </div>
    </div>

    <div id="filters">
        <h3>Show Nodes</h3>
        <label><input type="checkbox" checked data-type="agency"> Agencies <span id="count-agency"
                style="color:#888; font-size:10px;">(0)</span></label>
        <label><input type="checkbox" checked data-type="project"> Projects <span id="count-project"
                style="color:#888; font-size:10px;">(0)</span></label>
        <label><input type="checkbox" checked data-type="traditional"> Traditionals <span id="count-traditional"
                style="color:#888; font-size:10px;">(0)</span></label>
        <label><input type="checkbox" checked data-type="person"> People <span id="count-person"
                style="color:#888; font-size:10px;">(0)</span></label>
        <h3 style="margin-top: 12px;">Focus Landmark</h3>
        <select id="landmark-select">
            <option value="">All Landmarks</option>
        </select>
    </div>

    <div id="tooltip">
        <div class="tt-name"></div>
        <div class="tt-type"></div>
        <div class="tt-meta"></div>
    </div>

    <div id="graph-view">
        <svg></svg>
    </div>

    <div id="list-view"></div>

    <script>
        let currentTargetNode = null;
        let graphData = null;
        const isViewOnly = window.location.hostname.includes('vercel.app');

        const NODE_COLORS = {
            agency: '#6ee7b7',
            project: '#3b82f6',
            traditional: '#a78bfa',
            person: '#fb7185',
            landscape: 'transparent'
        };

        const EDGE_COLORS = {
            founder: '#6ee7b7',
            alumni: '#3b82f6',
            partner: '#a78bfa',
            collaborator: '#f59e0b',
            notable: '#fb7185',
            competitor: '#f97316',
            landscape: 'rgba(255,255,255,0.02)'
        };

        const NODE_RADIUS = {
            agency: 8,
            project: 3,
            traditional: 5,
            person: 7,
            landscape: 0
        };

        // ‚îÄ‚îÄ‚îÄ View Switching ‚îÄ‚îÄ‚îÄ
        function switchView(view) {
            document.querySelectorAll('.view-tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
            document.getElementById('graph-view').style.display = view === 'graph' ? 'block' : 'none';
            document.getElementById('list-view').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('legend').style.display = view === 'graph' ? 'block' : 'none';
            document.getElementById('filters').style.display = view === 'graph' ? 'block' : 'none';
            document.getElementById('research-panel').style.display = (view === 'graph' && !isViewOnly) ? 'block' : 'none';
            if (view === 'list') buildListView();
        }

        function buildListView() {
            if (!graphData) return;
            const container = document.getElementById('list-view');
            const nodes = graphData.nodes;
            const edges = graphData.edges;

            // ‚îÄ‚îÄ Build adjacency from edges ‚îÄ‚îÄ
            // For each agency, collect: people (founders/alumni), projects, traditionals (pedigree)
            const agencyKeys = Object.keys(nodes).filter(k => nodes[k].type === 'agency' && k !== 'landscape::center');
            const claimed = new Set(); // track nodes already shown under an agency

            // Sort: purely by addedAt (newest first)
            agencyKeys.sort((a, b) => {
                const tA = nodes[a].addedAt || '';
                const tB = nodes[b].addedAt || '';
                return tB.localeCompare(tA);
            });

            function getNeighbors(nodeKey) {
                const result = [];
                edges.forEach(e => {
                    if (e.from === nodeKey) result.push({ key: e.to, axis: e.axis, meta: e.meta });
                    if (e.to === nodeKey) result.push({ key: e.from, axis: e.axis, meta: e.meta });
                });
                return result;
            }

            function relativeTime(iso) {
                if (!iso) return '';
                const diff = Date.now() - new Date(iso).getTime();
                const mins = Math.floor(diff / 60000);
                if (mins < 1) return 'just now';
                if (mins < 60) return `${mins}m ago`;
                const hrs = Math.floor(mins / 60);
                if (hrs < 24) return `${hrs}h ago`;
                const days = Math.floor(hrs / 24);
                if (days < 7) return `${days}d ago`;
                return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }

            let html = '';

            // ‚îÄ‚îÄ Changelog Banner (data-driven, works on Vercel) ‚îÄ‚îÄ
            const changelog = graphData.changelog || [];
            if (changelog.length > 0) {
                html += `<div class="changelog-banner">`;
                html += `<div class="changelog-title">üì° Changelog</div>`;

                // Latest entry always visible
                const latest = changelog[0];
                html += renderChangelogEntry(latest);

                // Older entries in collapsible
                if (changelog.length > 1) {
                    html += `<button class="changelog-toggle" onclick="this.nextElementSibling.classList.toggle('open'); this.textContent = this.nextElementSibling.classList.contains('open') ? '‚ñ≤ Hide History' : '‚ñº Show History (${changelog.length - 1} more)';">‚ñº Show History (${changelog.length - 1} more)</button>`;
                    html += `<div class="changelog-history">`;
                    for (let i = 1; i < changelog.length; i++) {
                        html += renderChangelogEntry(changelog[i]);
                    }
                    html += `</div>`;
                }

                html += `</div>`;
            }

            function renderChangelogEntry(entry) {
                let h = `<div class="changelog-entry">`;
                h += `<div class="changelog-entry-header">`;
                h += `<span class="changelog-entry-title">${entry.title}</span>`;
                h += `<span class="changelog-type ${entry.type}">${entry.type}</span>`;
                h += `<span class="changelog-date">${entry.date}</span>`;
                h += `</div>`;
                if (entry.description) h += `<div class="changelog-desc">${entry.description}</div>`;
                if (entry.items && entry.items.length) {
                    h += `<div class="changelog-items">`;
                    for (const item of entry.items) h += `<span class="changelog-item">${item}</span>`;
                    h += `</div>`;
                }
                h += `</div>`;
                return h;
            }

            for (const agKey of agencyKeys) {
                const ag = nodes[agKey];
                claimed.add(agKey);

                // Gather direct neighbors
                const neighbors = getNeighbors(agKey);
                const people = [];
                const projects = [];
                const traditionals = [];
                const competitors = [];

                neighbors.forEach(n => {
                    const nd = nodes[n.key];
                    if (!nd) return;
                    if (nd.type === 'person') people.push({ ...nd, _key: n.key, _axis: n.axis, _meta: n.meta });
                    else if (nd.type === 'project') projects.push({ ...nd, _key: n.key, _axis: n.axis, _meta: n.meta });
                    else if (nd.type === 'traditional') traditionals.push({ ...nd, _key: n.key, _axis: n.axis, _meta: n.meta });
                    else if (nd.type === 'agency') competitors.push({ ...nd, _key: n.key, _axis: n.axis, _meta: n.meta });
                });

                // Also look one hop deeper: people ‚Üí their pedigree (traditionals)
                const pedigree = [];
                people.forEach(p => {
                    const pNeighbors = getNeighbors(p._key);
                    pNeighbors.forEach(pn => {
                        const pnd = nodes[pn.key];
                        if (pnd && pnd.type === 'traditional') {
                            pedigree.push({ ...pnd, _key: pn.key, _via: p.name, _meta: pn.meta });
                        }
                        // Also grab personal projects
                        if (pnd && pnd.type === 'project' && !projects.find(x => x._key === pn.key)) {
                            projects.push({ ...pnd, _key: pn.key, _axis: pn.axis, _meta: pn.meta, _via: p.name });
                        }
                    });
                });

                // Mark all as claimed
                people.forEach(p => claimed.add(p._key));
                projects.forEach(p => claimed.add(p._key));
                traditionals.forEach(t => claimed.add(t._key));
                pedigree.forEach(t => claimed.add(t._key));

                // ‚îÄ‚îÄ Render agency block ‚îÄ‚îÄ
                html += `<div class="agency-block">`;
                html += `<div class="agency-header">`;
                html += `<span class="agency-name${ag.isLandmark ? ' landmark' : ''}">${ag.name}</span>`;
                if (ag.isLandmark) html += `<span class="agency-tag">Landmark</span>`;
                html += `<span class="agency-date">${relativeTime(ag.addedAt)}</span>`;
                html += `</div>`;
                if (ag.bio) html += `<div class="agency-bio">${ag.bio}</div>`;

                // People
                if (people.length) {
                    html += `<div class="sub-section">`;
                    html += `<div class="sub-label people">People</div>`;
                    for (const p of people) {
                        const role = p._axis === 'founder' ? 'Founder' : (p._meta?.description || 'Member');
                        let links = '';
                        if (p.linkedIn) links += `<a href="${p.linkedIn}" target="_blank">in</a>`;
                        if (p.twitter) links += `<a href="${p.twitter}" target="_blank">ùïè</a>`;

                        html += `<div class="person-row">`;
                        html += `<span class="person-name">${p.name}</span>`;
                        html += `<span class="person-role">${role}</span>`;
                        if (links) html += `<span class="person-links">${links}</span>`;
                        if (p.bio) html += `<div class="person-bio">${p.bio}</div>`;
                        html += `</div>`;
                    }
                    html += `</div>`;
                }

                // Projects
                if (projects.length) {
                    // Sort: notable/viral first
                    projects.sort((a, b) => ((b.isNotable ? 1 : 0) + (b.isViral ? 1 : 0)) - ((a.isNotable ? 1 : 0) + (a.isViral ? 1 : 0)));
                    html += `<div class="sub-section">`;
                    html += `<div class="sub-label projects">Projects</div>`;
                    for (const p of projects) {
                        const nameHtml = p.url
                            ? `<a href="${p.url}" target="_blank">${p.name}</a>`
                            : p.name;
                        html += `<div class="project-row">`;
                        html += `<span class="project-dot${p.isNotable || p.isViral ? ' notable' : ''}"></span>`;
                        html += `<span class="project-name">${nameHtml}</span>`;
                        if (p.isViral) html += `<span class="project-flag viral">viral</span>`;
                        else if (p.isNotable) html += `<span class="project-flag notable">notable</span>`;
                        html += `</div>`;
                    }
                    html += `</div>`;
                }

                // Pedigree
                const uniquePedigree = [...new Map(pedigree.map(t => [t._key, t])).values()];
                if (uniquePedigree.length || traditionals.length) {
                    const allTrad = [...new Map([...traditionals, ...uniquePedigree].map(t => [t._key, t])).values()];
                    html += `<div class="sub-section">`;
                    html += `<div class="sub-label pedigree">Pedigree</div>`;
                    html += `<div>`;
                    for (const t of allTrad) {
                        const via = t._via ? ` via ${t._via}` : (t._meta?.description || '');
                        html += `<span class="pedigree-row">`;
                        html += `<span class="pedigree-name">${t.name}</span>`;
                        if (via) html += `<span class="pedigree-via">${via}</span>`;
                        html += `</span>`;
                    }
                    html += `</div></div>`;
                }

                // Related agencies (competitors)
                if (competitors.length) {
                    html += `<div class="sub-section">`;
                    html += `<div class="sub-label" style="color:#f59e0b">Related</div>`;
                    for (const c of competitors) {
                        const reason = c._meta?.description || '';
                        html += `<div class="related-row">`;
                        html += `<span class="related-arrow">‚Üí</span>`;
                        html += `<span class="related-name">${c.name}</span>`;
                        if (reason) html += `<span class="related-reason">‚Äî ${reason}</span>`;
                        html += `</div>`;
                    }
                    html += `</div>`;
                }

                html += `</div>`; // end agency-block
            }

            // ‚îÄ‚îÄ Unclaimed traditionals ‚îÄ‚îÄ
            const unclaimedTrad = Object.entries(nodes)
                .filter(([k, n]) => n.type === 'traditional' && !claimed.has(k));
            const unclaimedOther = Object.entries(nodes)
                .filter(([k, n]) => !claimed.has(k) && n.type !== 'traditional');

            if (unclaimedTrad.length || unclaimedOther.length) {
                html += `<div class="others-section">`;
                html += `<div class="others-title">Other Entities</div>`;
                html += `<div class="others-list">`;
                for (const [k, n] of [...unclaimedTrad, ...unclaimedOther]) {
                    html += `<span class="others-item">${n.name || k}</span>`;
                }
                html += `</div></div>`;
            }

            container.innerHTML = html;
        }

        async function init() {
            // ‚îÄ‚îÄ‚îÄ Mode Badge ‚îÄ‚îÄ‚îÄ
            const badge = document.getElementById('mode-badge');
            if (isViewOnly) {
                badge.textContent = 'VIEW ONLY';
                badge.className = 'mode-badge readonly';
            } else {
                badge.textContent = 'AGENT MODE';
                badge.className = 'mode-badge agent';
                document.getElementById('research-panel').style.display = 'block';
                loadQueueCount();
            }

            const res = await fetch('/api/mapper/graph');
            const graph = await res.json();
            graphData = graph;

            // ‚îÄ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ
            const statsBar = document.getElementById('stats-bar');
            const visibleNodeCount = Object.values(graph.nodes).filter(n => n.type !== 'landscape').length;
            const visibleEdgeCount = graph.edges.filter(e => e.axis !== 'landscape').length;
            statsBar.innerHTML = `
                <span><span class="num">${graph.landmarks.length}</span> landmarks</span>
                <span><span class="num">${visibleNodeCount}</span> nodes</span>
                <span><span class="num">${visibleEdgeCount}</span> edges</span>
            `;

            // ‚îÄ‚îÄ‚îÄ Landmark Dropdown ‚îÄ‚îÄ‚îÄ
            const landmarkSelect = document.getElementById('landmark-select');
            graph.landmarks.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l.name;
                opt.textContent = l.name;
                landmarkSelect.appendChild(opt);
            });

            // ‚îÄ‚îÄ‚îÄ Dynamic Counts ‚îÄ‚îÄ‚îÄ
            const counts = { agency: 0, project: 0, traditional: 0, person: 0 };
            Object.values(graph.nodes).forEach(n => {
                if (counts[n.type] !== undefined) counts[n.type]++;
            });
            for (const [type, count] of Object.entries(counts)) {
                const el = document.getElementById(`count-${type}`);
                if (el) el.textContent = `(${count})`;
            }

            // ‚îÄ‚îÄ‚îÄ Convert to D3 Format ‚îÄ‚îÄ‚îÄ
            const nodeMap = {};
            const nodes = [];
            const visibleTypes = new Set(['agency', 'traditional', 'person']);

            for (const [key, data] of Object.entries(graph.nodes)) {
                const node = { id: key, ...data };
                node.isLandscapeCenter = (data.type === 'landscape');
                node.radius = node.isLandscapeCenter ? 0 : (data.isLandmark ? 16 : (NODE_RADIUS[data.type] || 4));

                if (data.type === 'project' && (data.isViral || data.isNotable)) {
                    node.radius += 3;
                    node.color = '#f59e0b';
                } else {
                    node.color = data.isLandmark ? '#f59e0b' : (NODE_COLORS[data.type] || '#555');
                }

                node.isUnmapped = (data.type === 'agency' && data.mapStatus === 'unmapped');
                nodeMap[key] = node;
                nodes.push(node);
            }

            const links = graph.edges
                .filter(e => nodeMap[e.from] && nodeMap[e.to])
                .map(e => ({
                    source: e.from,
                    target: e.to,
                    axis: e.axis,
                    weight: e.weight,
                    color: EDGE_COLORS[e.axis] || '#333'
                }));

            // ‚îÄ‚îÄ‚îÄ SVG ‚îÄ‚îÄ‚îÄ
            const width = window.innerWidth;
            const height = window.innerHeight;
            const svg = d3.select('svg').attr('width', width).attr('height', height);
            const g = svg.append('g');

            const zoom = d3.zoom()
                .scaleExtent([0.1, 8])
                .on('zoom', (event) => g.attr('transform', event.transform));
            svg.call(zoom);
            svg.call(zoom.transform, d3.zoomIdentity.translate(width / 2, height / 2).scale(0.4));

            // ‚îÄ‚îÄ‚îÄ Forces ‚îÄ‚îÄ‚îÄ
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(d => {
                    if (d.axis === 'landscape') return 250;
                    if (d.axis === 'partner') return 30;
                    if (d.axis === 'founder') return 80;
                    return 60;
                }).strength(d => d.axis === 'landscape' ? 0.05 : d.weight * 0.3))
                .force('charge', d3.forceManyBody().strength(d => d.isLandscapeCenter ? 0 : (d.isLandmark ? -400 : -20)))
                .force('center', d3.forceCenter(0, 0))
                .force('collision', d3.forceCollide().radius(d => d.radius + 2))
                .alphaDecay(0.02);

            // ‚îÄ‚îÄ‚îÄ Draw ‚îÄ‚îÄ‚îÄ
            let link = g.append('g').selectAll('line').data(links).join('line')
                .attr('stroke', d => d.color)
                .attr('stroke-opacity', d => d.axis === 'landscape' ? 0 : 0.15)
                .attr('stroke-width', d => d.axis === 'landscape' ? 0 : Math.max(0.3, d.weight));

            let node = g.append('g').selectAll('circle').data(nodes).join('circle')
                .attr('r', d => d.radius)
                .attr('fill', d => d.isLandscapeCenter ? 'transparent' : (d.isUnmapped ? 'transparent' : d.color))
                .attr('stroke', d => d.isLandscapeCenter ? 'none' : (d.isLandmark ? '#f59e0b' : d.isUnmapped ? '#fb7185' : 'none'))
                .attr('stroke-width', d => d.isLandscapeCenter ? 0 : (d.isLandmark ? 3 : d.isUnmapped ? 2 : 0))
                .attr('stroke-dasharray', d => d.isUnmapped ? '3,2' : 'none')
                .attr('opacity', d => d.isLandscapeCenter ? 0 : (visibleTypes.has(d.type) || d.isLandmark ? 1 : 0.05))
                .style('cursor', d => d.isLandscapeCenter ? 'default' : 'pointer')
                .style('pointer-events', d => d.isLandscapeCenter ? 'none' : 'auto')
                .call(d3.drag()
                    .on('start', (e, d) => { if (d.isLandscapeCenter) return; if (!e.active) simulation.alphaTarget(0.1).restart(); d.fx = d.x; d.fy = d.y; })
                    .on('drag', (e, d) => { if (d.isLandscapeCenter) return; d.fx = e.x; d.fy = e.y; })
                    .on('end', (e, d) => { if (d.isLandscapeCenter) return; if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; })
                );

            // Glow
            node.filter(d => d.isLandmark).attr('filter', 'url(#glow)');
            const defs = svg.append('defs');
            const filter = defs.append('filter').attr('id', 'glow');
            filter.append('feGaussianBlur').attr('stdDeviation', '4').attr('result', 'coloredBlur');
            const feMerge = filter.append('feMerge');
            feMerge.append('feMergeNode').attr('in', 'coloredBlur');
            feMerge.append('feMergeNode').attr('in', 'SourceGraphic');

            // Stars for notable/viral
            const viralNodes = nodes.filter(d => d.isViral || d.isNotable);
            let stars = g.append('g').selectAll('text').data(viralNodes).join('text')
                .text('‚≠ê')
                .attr('font-size', '16px')
                .attr('text-anchor', 'middle')
                .attr('dy', '5px')
                .style('pointer-events', 'none')
                .style('text-shadow', '0 0 6px rgba(0,0,0,0.9)');

            // Labels
            const labelNodes = nodes.filter(d => d.isLandmark || (d.type === 'agency' && d.connections > 3));
            let labels = g.append('g').selectAll('text').data(labelNodes).join('text')
                .text(d => d.name)
                .attr('font-size', d => d.isLandmark ? '13px' : '9px')
                .attr('font-weight', d => d.isLandmark ? '800' : '500')
                .attr('fill', d => d.isLandmark ? '#f59e0b' : '#ccc')
                .attr('text-anchor', 'middle')
                .attr('dy', d => -(d.radius + 6))
                .style('pointer-events', 'none')
                .style('text-shadow', '0 0 6px rgba(0,0,0,0.9)');

            // ‚îÄ‚îÄ‚îÄ Tooltip ‚îÄ‚îÄ‚îÄ
            const tooltip = document.getElementById('tooltip');
            let hideTimeout;

            node.on('mouseover', (event, d) => {
                clearTimeout(hideTimeout);
                tooltip.style.display = 'block';
                tooltip.style.pointerEvents = 'auto';

                tooltip.querySelector('.tt-name').textContent = d.name || d.id;

                let typeHtml = d.type + (d.isLandmark ? ' ¬∑ LANDMARK' : '');
                if (d.source === 'agent') typeHtml += ' ü§ñ';
                tooltip.querySelector('.tt-type').textContent = typeHtml;

                let metaHtml = '';
                if (d.bio) metaHtml += `<div style="color: #e2e8f0; margin-bottom: 6px; line-height: 1.3;">${d.bio}</div>`;
                if (d.url) metaHtml += `<div style="margin-bottom: 6px;"><a href="${d.url}" target="_blank" style="color: #6ee7b7; text-decoration: underline;">View Project ‚Üó</a></div>`;

                let linksHtml = '';
                if (d.linkedIn) linksHtml += `<a href="${d.linkedIn}" target="_blank" style="color: #3b82f6; text-decoration: none; margin-right: 8px;">in</a>`;
                if (d.twitter) linksHtml += `<a href="${d.twitter}" target="_blank" style="color: #1da1f2; text-decoration: none;">ùïè</a>`;
                if (linksHtml) metaHtml += `<div style="margin-top: 6px; font-weight: bold;">${linksHtml}</div>`;

                if (d.connections) metaHtml += `<div style="margin-top: 4px; color: #888;">Links: ${d.connections}</div>`;
                tooltip.querySelector('.tt-meta').innerHTML = metaHtml;

                // Highlight connections
                const connectedIds = new Set();
                links.forEach(l => {
                    const src = typeof l.source === 'object' ? l.source.id : l.source;
                    const tgt = typeof l.target === 'object' ? l.target.id : l.target;
                    if (src === d.id) connectedIds.add(tgt);
                    if (tgt === d.id) connectedIds.add(src);
                });
                node.attr('opacity', n => n.id === d.id || connectedIds.has(n.id) ? 1 : 0.08);
                link.attr('stroke-opacity', l => {
                    const src = typeof l.source === 'object' ? l.source.id : l.source;
                    const tgt = typeof l.target === 'object' ? l.target.id : l.target;
                    return src === d.id || tgt === d.id ? 0.6 : 0.03;
                });
            })
                .on('mousemove', (event) => {
                    tooltip.style.left = (event.clientX + 16) + 'px';
                    tooltip.style.top = (event.clientY - 10) + 'px';
                })
                .on('mouseout', () => {
                    hideTimeout = setTimeout(() => { tooltip.style.display = 'none'; }, 500);
                    node.attr('opacity', d => visibleTypes.has(d.type) || d.isLandmark ? 1 : 0.05);
                    link.attr('stroke-opacity', 0.15);
                });

            tooltip.addEventListener('mouseenter', () => clearTimeout(hideTimeout));
            tooltip.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; });

            // ‚îÄ‚îÄ‚îÄ Node Selection (for pinning) ‚îÄ‚îÄ‚îÄ
            node.on('click', (event, d) => {
                if (event.defaultPrevented) return;
                currentTargetNode = d;

                // Highlight selected
                node.attr('stroke', n => n.id === d.id ? '#fff' : (n.isLandmark ? '#f59e0b' : (n.isUnmapped ? '#fb7185' : 'none')))
                    .attr('stroke-width', n => n.id === d.id ? 4 : (n.isLandmark ? 3 : (n.isUnmapped ? 2 : 0)))
                    .attr('stroke-dasharray', n => n.id === d.id ? '4,4' : (n.isUnmapped ? '3,2' : 'none'));

                // Update research panel
                if (!isViewOnly) {
                    document.getElementById('selected-name').textContent = d.name;
                    document.getElementById('selected-type').textContent = d.type + (d.isLandmark ? ' ¬∑ LANDMARK' : '');
                    document.getElementById('btn-pin').disabled = false;
                }
            });

            // ‚îÄ‚îÄ‚îÄ Tick ‚îÄ‚îÄ‚îÄ
            simulation.on('tick', () => {
                link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                node.attr('cx', d => d.x).attr('cy', d => d.y);
                labels.attr('x', d => d.x).attr('y', d => d.y);
                stars.attr('x', d => d.x).attr('y', d => d.y);
            });

            // ‚îÄ‚îÄ‚îÄ Filter Handlers ‚îÄ‚îÄ‚îÄ
            document.querySelectorAll('#filters input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    const type = cb.dataset.type;
                    if (cb.checked) visibleTypes.add(type);
                    else visibleTypes.delete(type);
                    node.attr('opacity', d => visibleTypes.has(d.type) || d.isLandmark ? 1 : 0.05);
                    node.attr('r', d => visibleTypes.has(d.type) || d.isLandmark ? d.radius : 1);
                });
            });

            landmarkSelect.addEventListener('change', () => {
                const selected = landmarkSelect.value;
                if (!selected) {
                    node.attr('opacity', d => visibleTypes.has(d.type) || d.isLandmark ? 1 : 0.05);
                    link.attr('stroke-opacity', 0.15);
                    return;
                }

                const lmKey = Object.keys(graph.nodes).find(k =>
                    graph.nodes[k].name?.toLowerCase() === selected.toLowerCase() && graph.nodes[k].isLandmark
                );
                if (!lmKey) return;

                const connected = new Set([lmKey]);
                graph.edges.forEach(e => {
                    if (e.from === lmKey) connected.add(e.to);
                    if (e.to === lmKey) connected.add(e.from);
                });

                node.attr('opacity', d => connected.has(d.id) ? 1 : 0.04);
                link.attr('stroke-opacity', l => {
                    const src = typeof l.source === 'object' ? l.source.id : l.source;
                    const tgt = typeof l.target === 'object' ? l.target.id : l.target;
                    return connected.has(src) && connected.has(tgt) ? 0.5 : 0.02;
                });
            });
        }

        // ‚îÄ‚îÄ‚îÄ Pin for Research ‚îÄ‚îÄ‚îÄ
        async function pinTarget() {
            if (isViewOnly || !currentTargetNode) return;
            const btn = document.getElementById('btn-pin');
            const status = document.getElementById('pin-status');
            const notes = document.getElementById('pin-notes').value.trim();

            btn.disabled = true;
            btn.textContent = '‚è≥ Pinning...';

            try {
                const res = await fetch('/api/mapper/pin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        targetNode: currentTargetNode.id,
                        targetName: currentTargetNode.name,
                        action: 'research',
                        notes
                    })
                });
                const data = await res.json();
                status.innerHTML = `<span style="color:#6ee7b7">‚úÖ Pinned "${currentTargetNode.name}" ‚Äî ${data.queued} in queue</span>`;
                document.getElementById('pin-notes').value = '';
                loadQueueCount();
            } catch (err) {
                status.innerHTML = `<span style="color:#fb7185">‚ùå ${err.message}</span>`;
            }

            btn.disabled = false;
            btn.textContent = 'üìå Pin for Research';
        }

        // ‚îÄ‚îÄ‚îÄ Queue Counter ‚îÄ‚îÄ‚îÄ
        async function loadQueueCount() {
            try {
                const res = await fetch('/api/mapper/queue');
                const queue = await res.json();
                const badge = document.getElementById('queue-badge');
                if (queue.length > 0) {
                    badge.textContent = queue.length;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            } catch (e) { /* ignore */ }
        }

        init().then(() => switchView('list'));
    </script>
</body>

</html>